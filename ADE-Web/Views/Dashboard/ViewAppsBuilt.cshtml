@model List<ADE_Web.Models.AppsBuiltModel>

@{
    ViewData["Title"] = "Apps Dashboard";
}

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Apps Dashboard</h2>
        <a asp-action="CreateAppsBuilt" class="btn btn-primary">+ Add New App</a>
    </div>

    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">@TempData["Success"]</div>
    }

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">No apps have been created yet.</div>
    }
    else
    {
        @foreach (var app in Model)
        {
            <table class="table table-bordered mb-4">
                <tbody>
                    <tr>
                        <th>App Name</th>
                        <td>@app.AppName</td>
                    </tr>
                    <tr>
                        <th>Description</th>
                        <td style="white-space: pre-wrap;">@app.AppDescription</td>
                    </tr>
                    <tr>
                        <th>GitHub URL</th>
                        <td>
                            @if (!string.IsNullOrWhiteSpace(app.AppGitHubUrl))
                            {
                                <a href="@app.AppGitHubUrl" target="_blank">@app.AppGitHubUrl</a>
                            }
                            else
                            {
                                <span class="text-muted">N/A</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <th>Improvements</th>
                        <td>
                            @if (app.appImprovements != null && app.appImprovements.Any())
                            {
                                <ul>
                                    @foreach (var imp in app.appImprovements)
                                    {
                                        <li>@imp.Improvement</li>
                                    }
                                </ul>
                            }
                            else
                            {
                                <span class="text-muted">No improvements added</span>
                            }
                        </td>
                    </tr>
                    <tr>
                        <th>Actions</th>
                        <td>
                            <div class="btn-group">
                                <a href="javascript:void(0);"
                                   class="btn btn-sm btn-outline-secondary edit-app-btn"
                                   data-id="@app.Id"
                                   data-name="@app.AppName"
                                   data-url="@app.AppGitHubUrl"
                                   data-description="@app.AppDescription"
                                   data-improvements='@Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                              app.appImprovements.Select(i => new { i.Id, i.Improvement })))'>
                                    Edit
                                </a>
                                <a href="javascript:void(0);"
                                   class="btn btn-sm btn-outline-danger delete-app-btn"
                                   data-id="@app.Id"
                                   data-name="@app.AppName">
                                    Delete
                                </a>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        }
    }
</div>

<!-- Edit App Modal -->
<div class="modal fade" id="editAppModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="editAppForm">
                <div class="modal-header">
                    <h5 class="modal-title">Edit App</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="AppId" name="AppId" />

                    <div class="mb-3">
                        <label for="AppName" class="form-label">App Name</label>
                        <input type="text" class="form-control" id="AppName" name="AppName" required />
                    </div>

                    <div class="mb-3">
                        <label for="AppGitHubUrl" class="form-label">GitHub URL</label>
                        <input type="text" class="form-control" id="AppGitHubUrl" name="AppGitHubUrl" />
                    </div>

                    <div class="mb-3">
                        <label for="AppDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="AppDescription" name="AppDescription" rows="4"></textarea>
                    </div>

                    <hr />
                    <h6>Improvements</h6>
                    <div id="improvements-container"></div>
                    <button type="button" class="btn btn-secondary btn-sm mt-2" id="add-improvement">+ Add Improvement</button>

                    <div id="editAppMessage" class="text-danger mt-2"></div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete App Modal -->
<div class="modal fade" id="deleteAppModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteAppForm">
                <div class="modal-header">
                    <h5 class="modal-title">Delete App</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="DeleteAppId" name="AppId" />
                    <p>Are you sure you want to delete <strong id="DeleteAppName"></strong>?</p>
                    <div id="deleteAppMessage" class="text-danger"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Delete App</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let improvementIndex = 0;

        // Open Edit modal
        $('.edit-app-btn').click(function ()
        {
            const btn = $(this);
            $('#AppId').val(btn.data('id'));
            $('#AppName').val(btn.data('name'));
            $('#AppGitHubUrl').val(btn.data('url'));
            $('#AppDescription').val(btn.data('description'));

            const container = $('#improvements-container');
            container.empty();
            improvementIndex = 0;

            const improvements = btn.data('improvements');
            if (improvements && improvements.length > 0)
            {
                improvements.forEach(function (imp)
                {
                    addImprovementField(imp.Id, imp.Improvement);
                });
            }

            $('#editAppMessage').text('');
            new bootstrap.Modal(document.getElementById('editAppModal')).show();
        });

        // Add improvement field
        function addImprovementField(id = 0, value = '')
        {
            const container = $('#improvements-container');
            const field = $(`
                            <div class="input-group mb-2">
                                <input type="hidden" name="Improvements[${improvementIndex}].Id" value="${id}" />
                                <input type="text" class="form-control" name="Improvements[${improvementIndex}].Improvement" value="${value}" placeholder="Enter improvement" />
                                <button type="button" class="btn btn-danger remove-improvement">Remove</button>
                            </div>
                        `);
            container.append(field);
            improvementIndex++;
        }

        // Add new improvement
        $('#add-improvement').click(function ()
        {
            addImprovementField();
        });

        // Remove improvement
        $('#improvements-container').on('click', '.remove-improvement', function ()
        {
            $(this).closest('.input-group').remove();
        });

        // Submit Edit form via AJAX
        $('#editAppForm').submit(function (e)
        {
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: '@Url.Action("UpdateAppsBuilt", "Dashboard")',
                data: $(this).serialize(),
                success: function () { location.reload(); },
                error: function (xhr) { $('#editAppMessage').text(xhr.responseText || 'Error occurred'); }
            });
        });

        // Delete App modal
        $('.delete-app-btn').click(function ()
        {
            const btn = $(this);
            $('#DeleteAppId').val(btn.data('id'));
            $('#DeleteAppName').text(btn.data('name'));
            $('#deleteAppMessage').text('');
            new bootstrap.Modal(document.getElementById('deleteAppModal')).show();
        });

        // Submit Delete via AJAX
        $('#deleteAppForm').submit(function (e)
        {
            e.preventDefault();
            $.ajax({
                type: "POST",
                url: '@Url.Action("DeleteApp", "Dashboard")',
                data: $(this).serialize(),
                success: function () { location.reload(); },
                error: function (xhr) { $('#deleteAppMessage').text(xhr.responseText || 'Error occurred'); }
            });
        });
    </script>
}
